# (10) EC2を立ち上げる 2.EC2の立ち上げ 

## 本章の目的：

- インスタンスを立ち上げる
- 操作の感覚をつかむ

***


本章では、サーバインスタンスの立ち上げを通じて、インスタンスに限定せずAWSを操作するという雰囲気・感覚をつかんでいただきます。

各種操作に慣れることを目的としているので、理論や設計、基礎知識は一切触れていません。今は分からなくても大丈夫！もちろんそれらが不要というわけではなく、全て後の方で出てきますのでご安心ください。分からないことがたくさん出てきますが、とりあえずは「先に進めること」に注力してください。詳細の解説は後の○○にて出てきます。

本章で分からない語句や技術があればメモしておき、○○でチェックしましょう。○○で解説していないし、ネットで検索しても分からない！という場合は、tech-boostの質問コーナーで投稿してください。解説を追加します。この繰り返しで、教材を充実していきましょう。

AWSマネジメントコンソール(以下「コンソール」)にログインした状態で学習を開始してください。

## 1. EC2を開く

![図1. AWSマネジメントコンソール(閉じた状態)](Fig1.png)

「すべてのサービス」をクリックして、すべてのサービスを開いてください。もちろん最初から開いている場合はそのままで結構です。

![図2. AWSマネジメントコンソール(開いた状態)](Fig2.png)

開いた中にEC2と表示されているので、それをクリックしてください。

![図3. EC2メニュー](Fig3.png)

EC2のメニューが開きました。次に、画面中央あたりにある「インスタンスの作成」ボタンをクリックしてください。

![図4. ステップ1:Amazon マシンイメージ(AMI)](Fig4.png)

Amazon マシンイメージ(AMI)を選択する画面が開きました。AMIとは、要はインスタンスのテンプレートのことです。ここではOSの選択をするという程度で理解してください。

ぜひ下までスクロールして、どんなOSが選択できるのかを知ってください。

そしてここでは、一番上の「Amazon Linux 2 AMI (HVM), SSD Volume Type」を選択しますので、左側にある「選択」ボタンをクリックしてください。

![図5. ステップ 2: インスタンスタイプの選択](Fig5.png)

インスタンスタイプの選択が開きました。先の画面でOSを選択したので、ここではインスタンスタイプ（規模）を選択します。「無料利用枠の対象」と書かれているt2.microが選択されていることを確認して下さい。さらにサーバインスタンスの詳細項目を指定できるのですが、今回は単にインスタンスを作るだけなので、何も変えず「確認と作成」ボタンをクリックしてください。。

![図6. ステップ 7: インスタンス作成の確認](Fig6.png)

最終確認の画面が開きました。諸々の内容はさておいて「作成」ボタンをクリックしてください。キーペアの選択画面が開きます。

![図7. キーペアの選択](Fig7.png)

アカウント登録したばかりの皆さんは、当然キーペアは1つも持っていません。「既存のキーペアの選択」プルダウンをクリックして「新しいキーペアの作成」を選択して下さい。キーペア名とダウンロード先の入力画面が開きます。

![図8. キーペアの新規作成](Fig8.png)


お好きなキーペア名を入力して「キーペアのダウンロード」ボタンをクリックして、キーペアをダウンロードしてください。

**重要！！：キーペアがどこにダウンロードされたのか確認しておきましょう。Mac/Windows共に、PCにログインしたアカウントのダウンロードフォルダです。**

キーペアは、次の接続するステップで使います。キーペアは紛失しても再発行不可能で、インスタンスにもアクセスできなくなります。厳重に保管しておいてください。

キーペアのダウンロードが終わったら「インスタンスの作成」ボタンをクリックしてください。

![図9. インスタンス作成中](Fig9.png)

インスタンスの作成が始まりました。5分程度したら、画面上の「サービス」から「EC2」を選択してください。

![図10. インスタンス作成完了](Fig10.png)

「リソース」にて「1個の実行中のインスタンス」をクリックしてください。

![図11. 実行中のインスタンス一覧](Fig11.png)

「インスタンスの状態」がrunningで「ステータスのチェック」が2/2であればインスタンスの立ち上げが完了しています。

いよいよ接続します。

「接続」ボタンをクリックしてください。

![図12. インスタンスへの接続](Fig12.png)

ここで表示されている情報は、Mac/Windowsともに参照しなくてはなりません。閉じないように気をつけてください。ここからはMacとWindowsで手順が異なりますので、ご使用のOSに応じて進めてください。

## 2. インスタンスへ接続する（Mac）

MacのLaunchpadより「ターミナル」を立ち上げてください。Launchpadの「その他」の中にあります。

![図13. Macのターミナル](Fig13.png)

赤い点線の上に、グレーのカーソルがあります。初めてターミナルを見たという方は、試しにaやbと打ち込んでみて下さい。赤い点線の上に打った文字が表示されるのが分かります。

以降、先頭の$より以前は省略します。入力するコマンドのみを記載します。教材に書いてあるままに入力して下さい。

コマンドを実行して下さい、とは「ターミナル上でコマンドを打ち込むか、またはどこかでコピーしたものをペースト（貼り付け）し、Enterする」ことを意味します。

まず、キーペアをダウンロードしたディレクトリ（フォルダと同じ意味）へ移動します。デフォルトでログインしたユーザーのDownloadsディレクトリにありますので、以下のコマンドで移動できます。

```cd ~/Downloads```

そこでダウンロードしたキーペアを探しましょう。以下のコマンドを実行してください。

``` ls -al | grep *.pem ```

間違いなくキーペアが存在していれば、以下のように表示されます。

```-rw-r--r--@   1 (PC名)  staff       1696  9 24 13:19 (キーペア名).pem```

何も表示されなければ、そこにはキーペアは存在していません。ダウンロードした場所を再確認してください。

次にキーペアのパーミッションを変更しましょう。

``` chmod 400 (キーペア名).pem ```

何もメッセージが表示されなければ成功です。念のため確認しておきましょう。もう一度以下のコマンドを実行してみてください。

``` ls -al | grep *.pem ```

先頭のrやwのあたりが変わります。

```-r--------@   1 (PC名)  staff       1696  9 24 13:19 (キーペア名).pem```

-rw-r--r--が-r--------に変われば成功です。

ここで、上で出てきた画面「インスタンスへの接続」の「例：」にあるssh〜で始まるコマンドを、そのままコピーして、ターミナルで貼り付けして下さい。

``` ssh -i "(キーペア名).pem" ec2-user@ec2-###-###-###-###.compute-1.amazonaws.com ```

Enterキーを押すと、以下のように表示されます。

```
(PC名):Downloads (PC名)$ ssh -i "(キーペア名).pem" ec2-user@ec2-###-###-###-###.compute-1.amazonaws.com
The authenticity of host '###-###-###-###.compute-1.amazonaws.com (###.###.###.###)' can't be established.
ECDSA key fingerprint is SHA256:(超長い英数字))
Are you sure you want to continue connecting (yes/no)? y
Please type 'yes' or 'no': yes 
```

yesかnoを聞いてきたので、yesと入力してEnterして下さい。

```Warning: Permanently added 'ec2-###-###-###-###.compute-1.amazonaws.com,###.###.###.###' (ECDSA) to the list of known hosts.

       __|  __|_  )
       _|  (     /   Amazon Linux 2 AMI
      ___|\___|___|

https://aws.amazon.com/amazon-linux-2/
2 package(s) needed for security, out of 9 available
Run "sudo yum update" to apply all updates.
```

2chを彷彿させるAA（アスキーアート：普通の文字を組み合わせて作った図柄）によるEC2のロゴが出てくれば成功です！インスタンスの立ち上げと接続ができました！あなたの指示により、海を越えてアメリカのAWSのデータセンター内にあなただけの仮想サーバができあがり、接続できているのです。

接続できたことに感動し、余韻にひたり終えたらexitコマンドを実行して切断します。

``` exit ```

ここまでできたので、本作業は完了です。『作業の後始末』へ進んでください。

## 3. インスタンスへ接続する（Windows）

Windowsからサーバインスタンスに接続するとき、Mac同様にSSH接続をします。しかしWindowsの場合は一工夫必要です。Macほど単純にSSH接続できないのです。Macは標準で、つまり何もインストールせずにSSH接続ができます。ところがWindowsでは、標準でSSH接続できず、何らかのアプリケーションをインストールしなければいけません。

厳密にいうとOpenSSHというWindows公式ツールがありますが、OSに標準搭載され始めたのは『Windows 10 April 2018 Update』からです。学習者の中にはWindows8や7をお使いの方がいるとすると、OpenSSHは選択肢から外さなくてはいけません。

インターネット上ではTeraTerm（テラターム）やPuTTY（パティ）を使った接続方法をよく目にします。AWSの公式サイトではPuTYYを使った説明をしています。

本コースでは、古くから存在しており定評のあるフリーツール、TeraTermを利用します。なお、PuTTYはAWSでダウンロードしたキーペアをPuTTY形式に変換しなくてはなりません。一方、TeraTermは複雑な設定は不要で、慣れてくれば運用にマクロを導入できるというメリットもあります。また多数のITの現場で使われており実績は数多くあります。以上より、本コースではTeraTermを採用しました。

もちろん、もしSSH接続ができる他のツールをお持ちなら、それを使っても大丈夫です。○◯へ進んでください。

### 3-1. TeraTermのダウンロード

TeraTermのダウンロードをしましょう。古くからあるフリーソフトのダウンロードサイト『窓の杜』へアクセスして下さい。ちなみに「まどのしゃ（社）」ではなく「まどのもり（杜）」です。多くの方がまちがって「しゃ」と読んでいます。まちがっている方が周りにいたら、できるだけ優しく訂正してあげてください。このサイトのロゴが木をモチーフとしていたり、ロゴの下にWINDOWS FOREST（FOREST:森林）と書いてあるのもうなずけますね。

今後、窓の杜を利用する機会があることを予想して、今回使って見慣れておきましょう。

話が逸れましたが、以下のリンクをクリックしてください。

＜リンク＞

＜画像１＞

赤枠の「窓の杜からダウンロード」ボタンをクリックしてください。

＜画像２＞

ここで注意して欲しいのは、**勝手にダウンロードが始まるので何もしないで待つ**ということです。この画面で「2018最新版」というボタンがありますが、これはあくまで別のアプリケーション『アバスト無料アンチウィルス』のダウンロードボタンです。このアプリケーションが欲しい場合を除いて、クリックしてはいけません。

ここからはお使いのブラウザや個人設定によって変わりますが、要は実行形式（.exe）のインストーラがダウンロードできればよいのです。Chromeでは、赤枠のような画面が表示されるので、「保存」ボタンをクリックすればインストーラがダウンロードできます。

＜画像３＞

2018年10月時点ではバージョン4.100なので、ダウンロードしたインストーラファイルの名称も「teraterm-4.100.exe」でした。ダウンロードしたインストーラをダブルクリックしてください。

〜〜　以降、次の画面が出るまで、全ての画面で何も変えずに次へ次へで進んでください。〜〜

＜画像４＞

このままセットアップまで済ませてしまうので「今すぐTera Term を実行する」にチェックを入れて「完了」ボタンをクリックしてください。TeraTermの接続設定画面が開きます。

＜画像５＞

ホスト名の欄に、前述の「接続」ボタンを押した時に表示されている情報の4番「〜amazonaws.com」をコピーペーストで貼り付けてください。

＜画像６＞

貼り付けたら、その他は何も変更せずに「OK」ボタンをクリックしてください。すると、ドキッとする画面が開きます。

＜画像７＞

セキュリティ警告、と出ますが、これは何か良くないことが起こったことを示すものではありません。そのまま「続行」ボタンをクリックしてください。

＜画像８＞

ユーザ名は「ec2-user」と入力してください。

「プレインパスワードを使う」というラジオボタンにチェックが入っていますが、その下の「RSA/DSA/ECDSA/ED2551９鍵を使う」にチェックを入れてください。すると、ラジオボタンの右の「秘密鍵」というボタンがアクティブになります。クリックするとファイル選択ダイアログが開くので、前述の手順でダウンロードした「〜.pem」を指定してください。

＜画像９＞

ただし、ファイル名の右のファイルの種類を「すべてのファイル」に変更しないとpemファイルは表示されないので注意してください。

ファイルを指定してもとの画面に戻ってきたら「OK」ボタンをクリックしてください。

＜画像１０＞

2chを彷彿させるAA（アスキーアート：普通の文字を組み合わせて作った図柄）によるEC2のロゴが出てくれば成功です！インスタンスの立ち上げと接続ができました！あなたの指示により、海を越えてアメリカのAWSのデータセンター内にあなただけの仮想サーバができあがり、接続できているのです。

接続できたことに感動し、余韻にひたり終えたらexitコマンドを実行して切断します。

##4. Webサーバのセットアップ

これまでの解説で立ち上げたサーバは、あくまで手順に慣れるためだけの仮想サーバであり、この章の終わりとともに消去してしまいます。その前に、Webサーバをセットアップして、もうひと余韻味わいましょう。

以下のコマンドを１行づつ実行してください。１行づつ実行とは、１行コピペで貼り付けてEnter、次の行をコピペで貼り付けてEnterという意味です。

```sudo yum -y install httpd```
```sudo service httpd start```

再びAWSマネジメントコンソールに戻り、開いている「接続」画面を閉じてください。

＜画像：コンソール＞

赤枠のlaunch-wizard-1をクリックしてください。

＜画像：セキュリティルール＞

「編集」ボタンをクリックしてください。

＜画像：ルールの編集＞

「ルールの追加」ボタンをクリックしてください。１行追加されます。追加された行の「タイプ」をクリックし、ドロップダウンメニューを表示させ、その中の「HTTP」をクリックしてください。

＜編集：ルールの追加が終わった＞

終われば「保存」ボタンをクリックしてください。

＜画像：ルールの追加が終わって戻ってきた＞

一度に２行追加されていますが気にしないでください。また、この画面はこのあとすぐに使うので、閉じたり他の画面へ遷移したりしないでください。

そして、ブラウザで前述の「接続」画面の4.で表示されているアドレスの先頭に「http://」をつけたURLにアクセスしてください。

```http://(「接続」画面の4.で表示されたアドレス)```

Apacheの標準画面が表示されました！

＜画像：Apache標準画面＞

いかがでしょうか？まだアプリを乗せる前なので、ただのWebサーバーの標準画面しか出ませんが、なんとなく感触はつかめましたか？もちろん、スマホからでもこのURLにてアクセスできます。

##5. 後始末をしましょう

以上で、作業の慣れを目的としたEC2インスタンスの立ち上げ・接続は終了です。これから順に後始末をしていきます。

##5-1. セキュリティルールの削除

セキュリティグループの「インバウンド」タブの「編集」ボタンをクリックしてください。

＜画像：HTTPルール削除前＞

HTTPの２行を右のほうにあるバツ印をクリックして消して「保存」ボタンをクリックしてください。

##5-2. サーバインスタンスから切断

Macの方はターミナル、Windowsの方はTeraTermの画面にて、```exit```と入力して、Enterキーを押してください。画面が自動的にクローズします。

##5-3. サーバインスタンスの終了ならびに削除






