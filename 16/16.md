# (16)VPC内にEC2を立ち上げる 

## 本章の目的：

- 前章で構築したVPC内にサーバインスタンスを立ち上げる。
- クライアントPCからVPC内のサーバインスタンスに接続する。

***

本章では、前章で構築したVPC内にサーバインスタンスを立ち上げます。今まで学習してきたインスタンスの立ち上げのおさらいになります。作業的に大きく異なるところはありません。ただ、VPC内に立ち上げるということだけ意識してください。

AWSマネジメントコンソールにて、EC2ダッシュボードを開いてください。

＜図１：EC２ダッシュボード＞

「インスタンスの作成」ボタンをクリックしてください。開いた画面で「AWSMarketPlace」をクリックし、検索窓で「CentOS7」と入力してください。

＜図２：CentOS7を選択＞

検索結果の中から「CentOS 7 (x86_64) - with Updates HVM」を選択してください。

＜図３：詳細表示＞

詳細が表示されますが、特に何もしなくても大丈夫です。確認後、「continue」ボタンをクリックしてください。

＜図４：タイプを選択＞

タイプを選択します。ここではデフォルトのt2.microのままにしてください。そして「次の手順」をクリック。

＜図５：インスタンス詳細の設定＞

ここで注意するのは「ネットワーク」と「サブネット」です。前章までで作成したものが表示されているかを確認してください。確認したら「確認と作成」ボタンをクリックしてください。

＜図６：インスタンス作成の確認＞

選択した内容が一通り表示されます。「作成」ボタンをクリックして次へ進みましょう。キーペアの選択画面が開きます。

＜図７：キーペアの選択＞

新たにキーペアを作成してもいいし、今までで作った既存のものを選択しても構いません。作成ならびに選択ができたら「インスタンスの作成」ボタンをクリックしてください。

数分待って、再びEC2ダッシュボードへ遷移すると、インスタンスができています。作成が終わって入れば、以下のような画面になっているはずです。下図でいうとインスタンスは2つあり、上の「running」の方が先ほど作ったものです。

＜図９：インスタンス作成完了＞

では早速接続して見ましょう。接続情報を確認するために「接続」ボタンをクリックしてください。

＜図10：接続情報表示＞

「例」で表示されているコマンドが接続コマンドです。rootと表示されていますが、rootでログインできません。「centos」ユーザでログインしてください。つまり、以下のようになります。

```
(PC名):~ (ログインユーザ名)$ ssh -i "tech-boost_instance1insub1.pem" centos@ec2-***-***-***-***.ap-northeast-1.compute.amazonaws.com
The authenticity of host 'ec2-***-***-***-***.ap-northeast-1.compute.amazonaws.com (***-***-***-***)' can't be established.
ECDSA key fingerprint is SHA256:(長い英数字と記号)
Are you sure you want to continue connecting (yes/no)? 
```

「yes」と入力してください。

```
[centos@ip-***-***-***-*** ~]$ 
```

AmazonLinuxを選択すると、AA(アスキーアート)でEC2!と表示されますが、CentOSでは素っ気無いですね。でも、表示がcentos@〜と変っていることから、一応はログインできていることが分かります。

続けて、OS等々を最新の状態にアップデートしておきましょう。

yumというコマンドを使い、OSならびに今インストールされているものを一括でupdateします。以下コマンドを実行してください。

```
sudo yum update -y
```

結構な時間がかかるので、根気よく待ちましょう。画面が落ち着くとupdateが終わっているはずです。

次に、mysqlをセットアップします。

```
sudo yum install -y mysql
```

これでOKです。Webアプリをセットアップする下準備ができました。

しかし１つ問題があります。今の状態だと、再起動するたびにサーバインスタンスのIPアドレスが変わってしまいます。よって固定のIPアドレスを取得してインスタンスに割り当てましょう。

EC2ダッシュボードの左のメニューの中に「ElasticIP」というリンクがありますのでクリックしてください。

＜図11：ElasticIP割り当て画面＞

「新しいアドレスの割り当て」ボタンをクリックしてください。

＜図12：IP割り当て完了＞

IPアドレスが一つ割り当たりました。感覚的に、IPアドレスを入手できた、といった方が分かりやすいでしょうか。これを先ほど起動したインスタンスに割り当てましょう。

画面左のメニュー「ElasticIP」をもう一度クリックすると、先ほど得たIPアドレスが表示されています。左のチェックボックスにチェックが入っている（青色になっている）ことを確認し「アクション」ボタンをクリックしてください。

＜図14：IPアドレスの関連付け＞

出てきたメニューの「IPアドレスの関連付け」をクリックしてください。

＜図15：IPアドレスをインスタンスに割り当てる＞

インスタンスは先ほど作ったものを選択、そして「再関連付け」にチェックを入れて「関連付け」ボタンをクリックしてください。

＜図16：IPアドレス割り当て完了＞

できました。EC2ダッシュボードに戻ると、先ほどのIPアドレスが割り当てられているのが分かります。

＜図17：ElasticIPアドレス割り当て後のインスタンス＞

この画面のまま、作成したインスタンスにチェックを入れて「接続」ボタンをクリックしてください。そこで表示されたsshコマンドを・・・あとは先ほどの手順と同じです。再度お伝えしますが、rootではなくcentosなのでお間違いなく。

「ssh〜」コマンドを実行した後、IPアドレスが変わったので既知のホストリストに追加するかどうかのメッセージが再度表示されます。そこは先ほどと同じくyesと入力してください。するとログインできるはずです。

これ以降、インスタンスを停止して再度起動しても、IPは変わりません。

Webサーバであるnginxやセキュリティグループの見直しは、これから徐々に進めます。とりあえずは最低限の設定が終わったことに喜びを感じ、ひとまず終わりにしましょう。

### まとめ

次章では、いよいよWebサーバならびにアプリの設定が始まります。さらに実務的な内容になります。ガンバってついてきてくださいね！
