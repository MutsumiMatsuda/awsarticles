# (21)Laravelアプリの公開 composerのインストール

## 本章の目的：Composerのインストール  


- composerとはRubyのバージョン管理rbenvとbundlerを足したようなものです。
- パッケージの依存関係を解消しながら、目的のパッケージをインストールしてくれるもの

 

***





#### まずcomposerのインストーラーを取得して、バイナリがあるとこに移動します。

```
$ curl -sS https://getcomposer.org/installer | sudo php

$ sudo mv composer.phar /usr/local/bin/composer

```

#### 実行権限を与えます。

```
$ sudo chmod +x /usr/local/bin/composer
```

chmod とは権限を与えるコマンドです。
パーミッションといいます。
必要な知識ですので、下記サイトなどを参照して、各自勉強しておいてください。

https://eng-entrance.com/linux-permission-basic


#### パーミッションの確認
バージョンが表示されるということは、composerが実行権限を持ったということです。

```
$ composer --version
Composer version 1.8.4 2019-02-11 10:52:10

```

#### Laravelプロジェクトフォルダをホーム配下に作ります


```
//==homeフォルダに移動して
$ cd

//==アプリのフォルダを作成します。名前は任意に決めてください。
$ mkdir mynews

```

#### gitで自分のアプリをpullしてきましょう。
ここでは、Laravelレッスンで作成したアプリをpullしています。

```
$ git init

$ git pull https://github.com/MutsumiMatsuda/mynews4ec2.git
```


#### WEBサーバーのnginxをインストールします。


```
$ sudo yum install nginx
$ sudo yum install nginx-all-modules

```

#### Laravelの環境ファイルを作ります。
プロジェクトの直下に作ります。
名前は .env



下記を貼り付けます。

```
APP_NAME=Laravel
APP_ENV=local
APP_KEY=base64:PAOxi8AN6ISrrDhmQaZEB9hEJgka7T2oRxNSXJkFeLQ=
APP_DEBUG=true
APP_URL=http://localhost

LOG_CHANNEL=stack

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=mynews4ec2
DB_USERNAME=root
DB_PASSWORD=

BROADCAST_DRIVER=log
CACHE_DRIVER=file
QUEUE_CONNECTION=sync
SESSION_DRIVER=file
SESSION_LIFETIME=120

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null

REDIS_PORT=6379

MAIL_DRIVER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null

PUSHER_APP_ID=
PUSHER_APP_KEY=
PUSHER_APP_SECRET=
PUSHER_APP_CLUSTER=mt1

MIX_PUSHER_APP_KEY="${PUSHER_APP_KEY}"
MIX_PUSHER_APP_CLUSTER="${PUSHER_APP_CLUSTER}"


# 松田追加

# Storage種別 (local or s3)
FILESYSTEM_DRIVER_TYPE_LOCAL=local
FILESYSTEM_DRIVER_TYPE_S3=s3

# 以下を切り替えてローカルとAWS S3に画像保存先を変更
#FILESYSTEM_DRIVER="${FILESYSTEM_DRIVER_TYPE_LOCAL}"
FILESYSTEM_DRIVER="${FILESYSTEM_DRIVER_TYPE_S3}"

NO_NEWS_IMAGE_FILENAME=no-image4news.png
NO_PROFILE_IMAGE_FILENAME=no-image4profile.png
IMAGE_URL_PREFIX=public/image

#S3の設定
AWS_S3_ACCESS_KEY=各自のACCESS_KEY
AWS_S3_SECRET_KEY=各自のSECRET_KEY
AWS_S3_REGION=ap-northeast-1
#AWS_S3_BUCKET=各自のバケット名
#AWS_S3_URL=https://s3-ap-northeast-1.amazonaws.com/各自のバケット名
```


#### composerのupdateするときにamazon のS3を使えるようにする。

composer.jsonのrequireに
#### "league/flysystem-aws-s3-v3" : "~1.0"
を追加


```
$ vi composer.json

//==一部省略
   "require": {
        "php": "^7.1.3",
        "doctrine/dbal": "^2.9",
        "fideloper/proxy": "^4.0",
        "laravel/framework": "5.7.*",
        "laravel/tinker": "^1.0",
     //==ここです
        "league/flysystem-aws-s3-v3" : "~1.0"
    },
```

### S3の定義をする。

#### config>filesystems.php

#### disksにs3の項目を追加します。

```
 'disks' => [
        // 松田変更ここから
        's3' => [
            'driver' => 's3',
            'key' => env('AWS_S3_ACCESS_KEY'),
            'secret' => env('AWS_S3_SECRET_KEY'),
            'region' => env('AWS_S3_REGION'),
            'bucket' => env('AWS_S3_BUCKET'),
            'url' => env('AWS_S3_URL'),
        // 松田変更ここまで
        ],

```

#### composerをupdateします




```
$ composer update
```

こんなエラーが出ます。
メモリが足りないと言っています。

```
The following exception is caused by a lack of memory or swap, or not having swap configured
Check https://getcomposer.org/doc/articles/troubleshooting.md#proc-open-fork-failed-errors for details

```



#### メモリ管理のswapファイルを変更します。

```
$ sudo dd if=/dev/zero of=/swap bs=1M count=1024

$ sudo mkswap /swap

$ swapon /swap

$ sudo swapon /swap

$ sudo chmod 600 /swap

//==チェックします。

$ free

//==良さそうですね
             total       used       free     shared    buffers     cached
Mem:       1009432     946648      62784         60       2056     681556
-/+ buffers/cache:     263036     746396
Swap:      1048572          0    1048572
```

#### 再度composerをupdateに挑戦
```
$ composer update


//==
Discovered Package: laravel/tinker
Discovered Package: nesbot/carbon
Discovered Package: nunomaduro/collision
Package manifest generated successfully.
```
うまくいきました。めでたし、めでたし






![図0. コンソール](17-0.png)



